<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>UM MVP — Імпортовані товари</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; background:#0b0b0b; color:#fff; }
    a { color: inherit; text-decoration: none; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
    .card { background:#141414; border-radius:16px; padding:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .card img { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; background:#222; }
    .title { font-size: 14px; margin: 8px 0 4px; line-height:1.3 }
    .brand { font-size: 12px; opacity: .7; }
    .price { font-weight: 600; margin-top:6px; }
    .row { display:flex; justify-content: space-between; align-items:center; gap:8px; }
    .link { font-size: 12px; color: #7dd3fc; text-decoration: none; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 999px; background:#1f2937; }
    .toolbar { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
    input, select { background:#141414; color:#fff; border:1px solid #333; border-radius:10px; padding:8px 10px; }
    .back { display:inline-block; margin-bottom:12px; color:#7dd3fc; }
    .gallery { display:flex; gap:10px; overflow:auto; padding-bottom:8px; }
    .gallery img { height: 260px; border-radius:12px; }
    .desc { background:#101010; border:1px solid #222; border-radius:12px; padding:12px; margin-top:12px; }
    .sizes { display:flex; gap:8px; flex-wrap: wrap; margin-top:8px; }
    .chip { background:#1f2937; padding:6px 10px; border-radius:999px; font-size:12px; }
    .buy { display:inline-block; margin-top:12px; padding:10px 14px; background:#2563eb; border-radius:12px; color:#fff; }
  </style>
</head>
<body>
  <div id="app"></div>

<script>
const el = (h, attrs={}, children=[]) => {
  const e = document.createElement(h);
  Object.entries(attrs).forEach(([k,v]) => (k==='class'? e.className=v : e.setAttribute(k,v)));
  (Array.isArray(children)?children:[children]).forEach(c => {
    if (c==null) return;
    if (typeof c === 'string') e.insertAdjacentHTML('beforeend', c);
    else e.appendChild(c);
  });
  return e;
};

function firstImage(x) {
  if (x.thumbnail) return x.thumbnail;
  const imgs = (x.images||'').split('|').filter(Boolean);
  return imgs.length ? imgs[0] : '';
}

async function listPage() {
  const app = document.getElementById('app');
  app.innerHTML = '';
  const r = await fetch('/products');
  const data = await r.json();

  const h1 = el('h1', {}, 'UM MVP — Імпортовані товари');
  const tb = el('div', {class:'toolbar'});
  const q = el('input', {id:'q', type:'search', placeholder:'Пошук по назві/бренду…'});
  const sel = el('select', {id:'brand'});
  sel.appendChild(el('option', {value:''}, 'Всі бренди'));
  [...new Set(data.map(x=>x.brand).filter(Boolean))].sort().forEach(b=>{
    sel.appendChild(el('option', {value:b}, b));
  });
  tb.appendChild(q); tb.appendChild(sel);

  const grid = el('div', {class:'grid'});
  const render = () => {
    const qq = (q.value||'').toLowerCase();
    const b = sel.value||'';
    grid.innerHTML = '';
    data.filter(x => (!b || x.brand===b) && (!qq || (x.title||'').toLowerCase().includes(qq) || (x.brand||'').toLowerCase().includes(qq)))
        .forEach(x=>{
          const card = el('div', {class:'card'});
          const img = el('img', {src:firstImage(x), alt:''});
          const brand = el('div', {class:'brand'}, x.brand||'');
          const title = el('div', {class:'title'}, x.title||'');
          const row = el('div', {class:'row'});
          const price = el('div', {class:'price'}, (x.price? (x.price+' '+(x.currency||'')) : ''));
          const stock = el('span', {class:'pill'}, x.stock_status||'');
          row.appendChild(price); row.appendChild(stock);
          const link = el('a', {class:'link', href:`/product/${x.id}`}, 'Відкрити картку →');
          card.appendChild(img); card.appendChild(brand); card.appendChild(title); card.appendChild(row); card.appendChild(link);
          grid.appendChild(card);
        });
  };
  q.oninput = render; sel.onchange = render;
  render();

  app.appendChild(h1);
  app.appendChild(tb);
  app.appendChild(grid);
}

async function productPage(pid) {
  const app = document.getElementById('app');
  app.innerHTML = '';
  const back = el('a', {href:'/', class:'back'}, '← Назад до каталогу');
  app.appendChild(back);

  const r = await fetch(`/product/${pid}`);
  if (!r.ok) { app.appendChild(el('div',{},'Не знайдено')); return; }
  const x = await r.json();

  const h = el('h1',{}, (x.brand? x.brand+' · ' : '') + (x.title||''));
  app.appendChild(h);

  const gal = el('div', {class:'gallery'});
  (x.images||[]).forEach(u=> gal.appendChild(el('img', {src:u, alt:''})));
  app.appendChild(gal);

  const row = el('div', {class:'row'});
  row.appendChild(el('div', {class:'price'}, (x.price? (x.price+' '+(x.currency||'')) : '')));
  row.appendChild(el('span', {class:'pill'}, x.stock_status||''));
  app.appendChild(row);

  if (x.options && Array.isArray(x.options.sizes) && x.options.sizes.length) {
    const sizes = el('div', {class:'sizes'}, x.options.sizes.map(s=>el('span',{class:'chip'},s)));
    app.appendChild(sizes);
  }

  if (x.description_html) {
    const d = el('div', {class:'desc'}, '');
    d.innerHTML = x.description_html;
    app.appendChild(d);
  }

  const buy = el('a', {class:'buy', href:x.url, target:'_blank', rel:'noopener'}, 'Відкрити на джерелі →');
  app.appendChild(buy);
}

// простий роутер
function route() {
  const path = window.location.pathname;
  const m = path.match(/^\/product\/(\d+)/);
  if (m) productPage(m[1]); else listPage();
}
window.addEventListener('popstate', route);
document.addEventListener('click', (e)=>{
  const a = e.target.closest('a[href^="/product/"], a[href="/"]');
  if (a && a.origin === window.location.origin) {
    e.preventDefault();
    history.pushState({}, '', a.getAttribute('href'));
    route();
  }
});
route();
</script>
</body>
</html>

